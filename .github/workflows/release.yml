name: release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options: [patch, minor, major]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      # --- Guard: repo must be clean right after checkout ---
      - name: Guard - ensure clean working tree
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Working tree is not clean after checkout:"
            git status --porcelain
            exit 1
          fi

      - name: Bump version (package.json + manifest.json)
        id: bump
        run: |
          VERSION="$(node scripts/bump-version.mjs "${{ inputs.bump }}")"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Guard - verify versions match
        run: node scripts/verify-version.mjs

      # --- Guard: fail if the tag already exists ---
      - name: Guard - tag must not already exist
        run: |
          TAG="v${{ steps.bump.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag already exists: $TAG"
            exit 1
          fi

      - name: Commit + tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json manifest.json
          git commit -m "chore(release): v${{ steps.bump.outputs.version }}"
          git tag "v${{ steps.bump.outputs.version }}"

      - name: Push commit + tag
        run: |
          git push
          git push --tags

      - name: Build + lint + package
        run: npm run ci

      - name: Upload XPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: fractured-json-viewer-xpi
          path: artifacts/*.xpi

      - name: Create GitHub Release + attach XPI (auto notes)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: v${{ steps.bump.outputs.version }}
          generate_release_notes: true
          files: artifacts/*.xpi
